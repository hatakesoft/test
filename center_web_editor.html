
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Center Web Editor</title>
    <style>
        body {
            margin: 0;
            font-family: monospace;
        }
        #editor {
            white-space: pre;
            padding: 10px;
            overflow: auto;
            height: 80vh;
            border: 1px solid #ccc;
        }
        #cmd {
            padding: 5px;
            border-top: 1px solid #ccc;
            background-color: #eee;
        }
        .dark {
            background-color: #282C34;
            color: #ABB2BF;
        }
        .light {
            background-color: #FAFAFA;
            color: #383A42;
        }
        .cursor {
            background-color: #528BFF;
            color: white;
        }
    </style>
</head>
<body>
    <input type="file" id="fileInput">
    <div id="editor" class="light"></div>
    <div id="cmd">Command: <span id="cmdBuffer"></span></div>

    <script>
        class File {
            constructor() {
                this.content = [];
            }
            setContent(lines) {
                this.content = lines;
            }
            getLine(y) {
                return this.content[y] || "";
            }
            getLength() {
                return this.content.length;
            }
        }

        class Display {
            constructor() {
                this.centerX = 0;
                this.centerY = 0;
                this.theme = "light";
            }
            setTheme(theme) {
                this.theme = theme;
                document.getElementById("editor").className = theme;
            }
            render(file) {
                const editor = document.getElementById("editor");
                editor.innerHTML = "";
                for (let y = 0; y < file.getLength(); y++) {
                    const line = file.getLine(y);
                    const div = document.createElement("div");
                    if (y === this.centerY) {
                        const before = document.createTextNode(line.slice(0, this.centerX));
                        const cursor = document.createElement("span");
                        cursor.className = "cursor";
                        cursor.textContent = line[this.centerX] || " ";
                        const after = document.createTextNode(line.slice(this.centerX + 1));
                        div.appendChild(before);
                        div.appendChild(cursor);
                        div.appendChild(after);
                    } else {
                        div.textContent = line;
                    }
                    editor.appendChild(div);
                }
            }
            moveUp(file) {
                if (this.centerY > 0) {
                    this.centerY--;
                    this.adjustX(file);
                }
            }
            moveDown(file) {
                if (this.centerY < file.getLength() - 1) {
                    this.centerY++;
                    this.adjustX(file);
                }
            }
            moveLeft() {
                if (this.centerX > 0) {
                    this.centerX--;
                }
            }
            moveRight(file) {
                if (this.centerX < file.getLine(this.centerY).length) {
                    this.centerX++;
                }
            }
            adjustX(file) {
                const lineLength = file.getLine(this.centerY).length;
                if (this.centerX > lineLength) {
                    this.centerX = lineLength;
                }
            }
        }

        class Cmd {
            constructor() {
                this.buffer = "";
                this.history = "";
            }
            check(cmdMsg, key) {
                const start = this.buffer + key;
                if (cmdMsg.startsWith(start)) {
                    this.buffer += key;
                    if (cmdMsg === start) {
                        this.history += this.buffer;
                        this.buffer = "";
                        return true;
                    }
                }
                return false;
            }
            key(key, display, file) {
                if (key === "Backspace") {
                    this.buffer = "";
                } else if (this.check("j", key)) {
                    display.moveDown(file);
                } else if (this.check("h", key)) {
                    display.moveLeft();
                } else if (this.check("k", key)) {
                    display.moveRight(file);
                } else if (this.check("i", key)) {
                    display.moveUp(file);
                } else if (this.check("q", key)) {
                    alert("終了します");
                    return false;
                } else if (this.check("t:one_dark", key)) {
                    display.setTheme("dark");
                } else if (this.check("t:one_light", key)) {
                    display.setTheme("light");
                }
                return true;
            }
        }

        const file = new File();
        const display = new Display();
        const cmd = new Cmd();

        document.getElementById("fileInput").addEventListener("change", function(event) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const lines = e.target.result.split("\n");
                file.setContent(lines);
                display.render(file);
            };
            reader.readAsText(event.target.files[0]);
        });

        document.addEventListener("keydown", function(event) {
            const key = event.key;
            if (!cmd.key(key, display, file)) return;
            document.getElementById("cmdBuffer").textContent = cmd.buffer;
            display.render(file);
        });
    </script>
</body>
</html>
